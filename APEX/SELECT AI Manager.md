Thanks for stopping by!  Continue reading to understand what we covered in our Unlock the Full Potential of Your Oracle AI Database Select AI Profiles session

This session was designed to show how users can quickly develop an APEX app to Create, Manage, Run, and Review their SELECT AI Profiles.


#### Database: Autonomous AI Database Lakehouse 26ai
#### APEX Version: 24.2
___
#### Code Snippets
<details>
 <summary> Database Grants to APEX Workspace </summary>

    --Need to be granted as Admin
    grant execute on DBMS_CLOUD to <Workspace Schema>;
    grant execute on DBMS_CLOUD_AI to W<Workspace Schema>;
    
</details>

<details>
 <summary> Credentials </summary>


    --Check for Credentials
     select * from user_credentials;
    
    --Create Credential for OCI Hosted Generative AI Models
     BEGIN
         DBMS_CLOUD.CREATE_CREDENTIAL (
         credential_name => 'OCI_CREDENTIAL',
         user_ocid => '<User OCID>',
         tenancy_ocid => '<Tenancy OCID>',
         private_key => '<Private Key>',
         fingerprint => '<Fingerprint>');
     END;
     /
    
    --Drop Credential
     BEGIN
       DBMS_CLOUD.DROP_CREDENTIAL (
        credential_name  => 'OCI_CREDENTIAL');
     END;

</details>

<details>
 <summary> Supporting Database Ojects </summary>
        
   
    --Available Models
       CREATE TABLE "SELECT_AI_OCI_MODELS" 
       (	"MODEL_ID" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  NOT NULL ENABLE, 
    	"MODEL_NAME" VARCHAR2(100 CHAR) NOT NULL ENABLE, 
    	"MODEL_DISPLAY_NAME" VARCHAR2(100), 
    	 CONSTRAINT "OCI_MODELS_PK" PRIMARY KEY ("MODEL_ID")
      USING INDEX  ENABLE
       ) ;
    
     --Insert Models
      INSERT INTO SELECT_AI_OCI_MODELS (MODEL_NAME, MODEL_DISPLAY_NAME) VALUES ('meta.llama-3.2-90b-vision-instruct', 'Meta Llama 3.2 Vision');
      INSERT INTO SELECT_AI_OCI_MODELS (MODEL_NAME, MODEL_DISPLAY_NAME) VALUES ('cohere.command-a-03-2025', 'Cohere Cmd A');
      INSERT INTO SELECT_AI_OCI_MODELS (MODEL_NAME, MODEL_DISPLAY_NAME) VALUES ('google.gemini-2.5-flash-lite', 'Gemini 2.5 Flash Lite');
      INSERT INTO SELECT_AI_OCI_MODELS (MODEL_NAME, MODEL_DISPLAY_NAME) VALUES ('xai.grok-3-mini', 'Grok 3 Mini');
   
    
    --SELECT AI Actions table
        CREATE TABLE "SELECT_AI_ACTIONS" 
      (	"ACTION_ID" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  NOT NULL ENABLE, 
   	"ACTION_NAME" VARCHAR2(25 CHAR), 
   	 CONSTRAINT "SELECT_AI_ACTIONS_PK" PRIMARY KEY ("ACTION_ID")
     USING INDEX  ENABLE
      ) ;
      
    --Insert Actions
      INSERT INTO SELECT_AI_ACTIONS (ACTION_NAME) VALUES ('explainsql');
      INSERT INTO SELECT_AI_ACTIONS (ACTION_NAME) VALUES ('chat');
      INSERT INTO SELECT_AI_ACTIONS (ACTION_NAME) VALUES ('narrate');
      INSERT INTO SELECT_AI_ACTIONS (ACTION_NAME) VALUES ('runsql');
      INSERT INTO SELECT_AI_ACTIONS (ACTION_NAME) VALUES ('showsql');
   
   
    --Feedback/Audit Table
         CREATE TABLE "SELECT_AI_FEEDBACK" 
       (	"SA_ID" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  NOT NULL ENABLE, 
    	"SA_USER" VARCHAR2(75 CHAR) NOT NULL ENABLE, 
    	"SA_PROMPT" VARCHAR2(1000 CHAR), 
    	"SA_RESULTS" VARCHAR2(5000 CHAR), 
    	"SA_CREATED_ON" TIMESTAMP (6) DEFAULT systimestamp NOT NULL ENABLE, 
    	"FEEDBACK" VARCHAR2(20 CHAR), 
    	"SA_PROFILE" VARCHAR2(100), 
    	"SA_ACTION" VARCHAR2(25), 
    	 CONSTRAINT "SELECT_AI_Feedback_PK" PRIMARY KEY ("SA_ID")
      USING INDEX  ENABLE
       ) ;


</details>

<details>
<summary> REST API Endpoint </summary>
        
        Declare
            l_task_id varchar2(50) := :task_id; --task_id passed via URL Parameter
            l_outcome varchar2(50) := :outcome; --outcome passed via URL Parameter
            l_token varchar2(4000) := :token;   --token passed via URL Parameter
        
            l_used_flag varchar2(10);           --token used?
            l_username varchar2(500);           -- current owner of task
            l_hash raw(32);                     --secure summary of the original token, stored in DB.
        
            --l_activity_params WWV_FLOW_GLOBAL.VC_MAP;   --(send parameters to workflow) data type to store keyâ€“value pairs (bundle multiple related values together in one )
            l_workflow_id varchar2(50);                 --ID stored in DB table
        
        Begin
        
        select USED_FLAG,WORKFLOW_ID, TOKEN_HASH into l_used_flag, l_workflow_id, l_hash  from EMAIL_TASK_APPROVALS where TASK_ID = l_task_id;
        select ACTUAL_OWNER into l_username from APEX_TASKS where TASK_ID = l_task_id;
        
        
        
        CASE WHEN l_used_flag = 'N' and l_hash = DBMS_CRYPTO.HASH(l_token, DBMS_CRYPTO.HASH_SH256)then    
            --process workflow. You need a valid APEX session to take action on tasks
                APEX_SESSION.CREATE_SESSION (
                    p_app_id =>500,
                    p_page_id =>1,
                    p_username =>l_username);
        
                CASE WHEN l_outcome = 'APPROVED' THEN
                        apex_human_task.APPROVE_TASK(       --approve task
                        p_task_id => l_task_id);
                        --l_activity_params('TASK_OUTCOME') := APEX_APPROVAL.C_TASK_OUTCOME_APPROVED; --set workflow parameter
                    WHEN l_outcome = 'REJECTED' THEN
                        apex_human_task.REJECT_TASK( --reject task
                        p_task_id => l_task_id);
                        --l_activity_params('TASK_OUTCOME') := APEX_APPROVAL.C_TASK_OUTCOME_REJECTED; --set workflow parameter
                    ELSE 
                        null;
                        --Do something
                END CASE;
        
                --l_user_agent := OWA_UTIL.get_cgi_env('HTTP_USER_AGENT');
        	    --l_ip := OWA_UTIL.get_cgi_env('REMOTE_ADDR');
        
                UPDATE EMAIL_TASK_APPROVALS
                    SET USED_FLAG = 'Y', 
                    USED_AT = systimestamp
                    WHERE task_id = l_task_id
                    AND token_hash = DBMS_CRYPTO.HASH(l_token, DBMS_CRYPTO.HASH_SH256);
        
                
                -- MIME type to html
            owa_util.mime_header('text/html', FALSE);
            htp.p('Cache-Control: no-cache');
            owa_util.http_header_close;
            htp.p('<!DOCTYPE html>');
                htp.p('<html lang="en">');
                htp.p('<head>');
                htp.p('  <meta charset="UTF-8">');
                htp.p('  <meta name="viewport" content="width=device-width, initial-scale=1.0">');
                htp.p('  <title>Task Approved</title>');
                htp.p('  <style>');
                htp.p('    body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }');
                htp.p('    .container { max-width: 600px; margin: 50px auto; background: #fff; padding: 30px; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; }');
                htp.p('    h1 { color: #333; }');
                htp.p('    p { color: #555; line-height: 1.6; }');
                htp.p('    a { color: #007bff; text-decoration: none; }');
                htp.p('    a:hover { text-decoration: underline; }');
                htp.p('    .message {padding: 16px;font-size: 18px;font-weight: bold;color: #155724;background-color: #d4edda;border: 1px solid #c3e6cb;border-radius: 8px;box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);}');
                htp.p('    .messageRejected {padding: 16px;font-size: 18px;font-weight: bold;color: #721c24;background-color: #f8d7da;border: 1px solid #f5c6cb;border-radius: 8px;box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);}');
                htp.p('  </style>');
                htp.p('</head>');
                htp.p('<body>');
                htp.p('  <div class="container">');
                htp.p('    <h1>Thank you '|| l_username||'!</h1>');
                IF l_outcome = 'APPROVED' THEN
                        htp.p('    <div class="message"> &#10004; You have approved the task. We have captured your response. </div>');
                ELSIF l_outcome = 'REJECTED' THEN
                        htp.p('    <div class="messageRejected">&#10004; You have Rejected the task. We have captured your response.</div>');
                ELSE
                        htp.p('    <div class="messageRejected">Invalid task status provided.</div>');
                END IF;
                htp.p('    <p>You can now close this window or click the link below to return to the application.</p>');
                htp.p('    <p><a href="https://your-apex-url">Return to Application</a></p>');
                htp.p('  </div>');
                htp.p('  <script>');
                htp.p('//JavaScript Code Here');
                htp.p('//window.close();');
                htp.p('  </script>');
                htp.p('</body>');
            htp.p('</html>');
             
        WHEN l_used_flag = 'Y' or l_hash != DBMS_CRYPTO.HASH(l_token, DBMS_CRYPTO.HASH_SH256)  then
            owa_util.mime_header('text/html', FALSE);
            htp.p('Cache-Control: no-cache');
            owa_util.http_header_close;
            htp.p('<!DOCTYPE html>');
                htp.p('<html lang="en">');
                htp.p('<head>');
                htp.p('  <meta charset="UTF-8">');
                htp.p('  <meta name="viewport" content="width=device-width, initial-scale=1.0">');
                htp.p('  <title>One-Time Link Used</title>');
                htp.p('  <style>');
                htp.p('    body { font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }');
                htp.p('    .container { max-width: 600px; margin: 50px auto; background: #fff; padding: 30px; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 8px; }');
                htp.p('    h1 { color: #333; }');
                htp.p('    .messageError { color: #d9534f; font-size: 18px; margin: 20px 0; }');
                htp.p('    p { color: #555; line-height: 1.6; }');
                htp.p('    a { color: #007bff; text-decoration: none; }');
                htp.p('    a:hover { text-decoration: underline; }');
                htp.p('    .message {padding: 16px;font-size: 18px;font-weight: bold;color: #155724;background-color: #d4edda;border: 1px solid #c3e6cb;border-radius: 8px;box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);}');
                htp.p('    .messageRejected {padding: 16px;font-size: 18px;font-weight: bold;color: #721c24;background-color: #f8d7da;border: 1px solid #f5c6cb;border-radius: 8px;box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);}');
                htp.p('  </style>');
                htp.p('</head>');
                htp.p('<body>');
                htp.p('  <div class="container">');
                htp.p('    <h1>Notice</h1>');
                htp.p('    <div class="messageError">');
                htp.p('      The one-time use token you provided has already been used or there was a system error.');
                htp.p('    </div>');
                htp.p('    <p>If you believe this is a mistake, please contact your system administrator.</p>');
                htp.p('    <p>You can close this window or <a href="https://your-apex-url">return to the application</a>.</p>');
                htp.p('  </div>');
                htp.p('</body>');
            htp.p('</html>');
        
        ELSE
            null;
            --Do Something else
        END CASE;
        
        End;
</details>

___
### Scheduling a Database Job

<details>
 
<summary> Step-by-step instructions on how to create a database job </summary>
 
To anyone that stumbled across this section of the repo, apologies for not covering this during the demo.  That was part of the plan, but was running short on time.  I've outlined the steps necessary to setup a re-occurring job that will run your PL/SQL and initiate APEX workflows.

I'll be using the Scheduling service within Database Actions of an Autonomous Data Warehouse 23ai.

Start by logging into the database within OCI.  Open up Database Actions and select Scheduling

![Database Actions](</APEX/Images/DA - Scheduling.png> "Database Actions")

Select Create Job

![Database Actions](</APEX/Images/DA - Scheduling-Home.png> "Database Actions")

This will open the job details page

![Database Actions](</APEX/Images/Create Job.png> "Database Actions")

Give the job a name and paste your PL/SQL script

![Database Actions](</APEX/Images/Enter Details.png> "Database Actions")

Select Execution Mode

![Database Actions](</APEX/Images/Select Execution Mode.png> "Database Actions")

Configure Schedule

![Database Actions](</APEX/Images/Set up Mode.png> "Database Actions")

At this point, you should be able to save the job and you use the same area to monitor the job to ensure it's running as expected.

</details>

___

### Mentioned Links
Below are some links to documentation that we mentioned during the webinar

#### Database Credentials
 - Required when working with OCI resources to authenticate the request. [Documentation](https://docs.oracle.com/en/cloud/paas/autonomous-database/serverless/adbsb/dbms-cloud-subprograms.html#GUID-742FC365-AA09-48A8-922C-1987795CF36A)

#### JSON Functions
 - Very useful when working with JSON files and responses. We utilized the JSON_TABLE function, but many other JSON functions are available. [Documentation](https://docs.oracle.com/en/database/oracle/oracle-database/19/sqlrf/JSON_TABLE.html)

#### APEX Workflow Runtime Views
 - APEX provides views to help understand every aspect of the Workflow engine. [Documentation](https://docs.oracle.com/en/database/oracle/apex/24.2/htmdb/workflow-views.html#GUID-851AB064-5B41-432F-9CAF-00CF78D975E4)

Here are the example SQL statements for APEX views we utilized

        SELECT * FROM APEX_WORKFLOWS WHERE APPLICATION_ID = 500
        SELECT * FROM APEX_WORKFLOW_ACTIVITIES WHERE WORKFLOW_ID = 21648550992363173 ORDER BY START_TIME


#### APEX Workflow Substitution Strings
 - Substitution Strings are used to pass information about a workflow to an Oracle APEX page. [Documentation](https://docs.oracle.com/en/database/oracle/apex/24.2/htmdb/workflow-substitution-strings.html#GUID-110A2DE8-0586-45E3-A439-D3D56425FE10)

##### APEX Workflow APIs
 - Listing of available Workflow related APIs. [Documentation](https://docs.oracle.com/en/database/oracle/apex/23.2/aeapi/APEX_WORKFLOW.START_WORKFLOW-Function.html#GUID-EC513C91-8A56-46FD-A25D-16A9BF071804)

>**Note:** *We utilized the START_WORKFLOW function*

#### APEX In-Email Approvals
 - Blog posting describing alternative method for configuring in-email approvals. [Blog](https://blogs.oracle.com/apex/post/accelerate-decisionmaking-with-inemail-approvals-in-oracle-apex-workflows?source=:so:fb:or:awr:odv:::&SC=:so:fb:or:awr:odv:::&pcode=)

#### Scheduling
 - To learn more about scheduling database jobs. [Documention](https://docs.oracle.com/en/database/oracle/sql-developer-web/sdwad/scheduling-page.html)
___
### Code Innovate Program

More about the Code Innovate Program [Oracle Developers](https://www.oracle.com/developer/community/code-innovate-developers/)  
Code Innovate videos on [YouTube](https://www.youtube.com/playlist?list=PLPIzp-E1msrZMCfSHbKgLK3KWsNM9JB9a)  

If you're interested in learning more about the program, email us at **codeinnovate_us_grp@oracle.com** and one of our engineers will get in touch with you.
